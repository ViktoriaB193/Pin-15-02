<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>Color by Number Builder Pro</title>
<style>
  :root { --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9; --primary: #38bdf8; --accent: #c084fc; }
  body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: grid; grid-template-columns: 400px 1fr; }
  
  /* Панель управления */
  .sidebar { background: var(--panel); border-right: 1px solid #334155; display: flex; flex-direction: column; overflow: hidden; }
  .header { padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid #334155; }
  .scroll { padding: 20px; overflow-y: auto; flex: 1; }
  
  .section { margin-bottom: 20px; padding: 15px; background: #0f172a; border-radius: 12px; border: 1px solid #334155; }
  h3 { margin: 0 0 10px; font-size: 11px; text-transform: uppercase; color: var(--primary); letter-spacing: 1px; }
  
  input, textarea, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: #fff; margin-bottom: 10px; outline: none; }
  .btn { width: 100%; padding: 12px; border-radius: 8px; border: 0; cursor: pointer; font-weight: bold; transition: 0.2s; background: var(--primary); color: #000; margin-bottom: 5px; }
  .btn:hover { filter: brightness(1.2); }
  .btn.sec { background: #475569; color: #fff; }
  
  /* Холст */
  .canvas-area { display: flex; align-items: center; justify-content: center; background: #020617; position: relative; padding: 40px; }
  .frame { position: relative; line-height: 0; transition: 0.3s; }
  #mainImg { max-width: 100%; max-height: 80vh; display: block; pointer-events: none; }
  #mainSvg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; }
  
  .list-item { background: #1e293b; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; border: 1px solid #334155; }
  .color-row { display: flex; gap: 10px; align-items: center; }
  input[type="color"] { width: 50px; height: 40px; padding: 2px; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="header">
    <div style="font-weight:900; font-size:18px;">GENIALLY PAINT PRO</div>
    <div style="font-size:11px; opacity:0.6">Создание раскраски с кликом по номерам</div>
  </div>
  
  <div class="scroll">
    <div class="section">
      <h3>1. Картинка и стиль</h3>
      <input type="file" id="fileInp" accept="image/*">
      <label style="font-size:12px; display:block; margin-bottom:5px;">Цвет неоновой рамки:</label>
      <input type="color" id="glowColor" value="#38bdf8">
    </div>

    <div class="section">
      <h3>2. Обводка области</h3>
      <div style="font-size:12px; opacity:0.7; margin-bottom:10px;">Кликайте по картинке, чтобы обвести деталь.</div>
      <button class="btn sec" onclick="undoPoint()">Шаг назад</button>
      
      <label style="font-size:12px; margin-top:10px; display:block;">Задание (например: 2 + 3):</label>
      <input type="text" id="taskInp" placeholder="Текст вопроса">
      
      <label style="font-size:12px; display:block;">Ответ (число):</label>
      <input type="text" id="ansInp" placeholder="Номер на картинке">
      
      <label style="font-size:12px; display:block;">Цвет закраски:</label>
      <input type="color" id="colorInp" value="#ff4d6d">
      
      <button class="btn" onclick="saveRegion()">СОХРАНИТЬ ОБЛАСТЬ</button>
    </div>

    <div class="section">
      <h3>3. Список заданий</h3>
      <div id="regList"></div>
    </div>

    <div class="section">
      <h3>4. Экспорт</h3>
      <button class="btn" style="background:var(--accent)" onclick="buildGame()">ПОЛУЧИТЬ КОД ДЛЯ GENIALLY</button>
      <textarea id="output" placeholder="Тут появится код..." readonly></textarea>
    </div>
  </div>
</div>

<div class="canvas-area">
  <div class="frame" id="previewFrame">
    <img id="mainImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
    <svg id="mainSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
  </div>
</div>

<script>
  let points = [];
  let regions = [];
  let currentImg = "";

  document.getElementById('fileInp').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => { 
      document.getElementById('mainImg').src = ev.target.result;
      currentImg = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  };

  document.getElementById('mainSvg').onclick = (e) => {
    const rect = e.target.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 1000;
    const y = ((e.clientY - rect.top) / rect.height) * 1000;
    points.push({x, y});
    draw();
  };

  function draw() {
    let h = '';
    if(points.length > 0) {
      const path = points.map(p => `${p.x},${p.y}`).join(' ');
      h += `<polyline points="${path}" fill="none" stroke="#38bdf8" stroke-width="3" />`;
      points.forEach(p => h += `<circle cx="${p.x}" cy="${p.y}" r="6" fill="#fff" />`);
    }
    regions.forEach(r => {
      const path = r.points.map(p => `${p.x},${p.y}`).join(' ');
      h += `<polygon points="${path}" fill="${r.color}66" stroke="${r.color}" stroke-width="1" />`;
    });
    document.getElementById('mainSvg').innerHTML = h;
  }

  function undoPoint() { points.pop(); draw(); }

  function saveRegion() {
    const task = document.getElementById('taskInp').value;
    const ans = document.getElementById('ansInp').value;
    const color = document.getElementById('colorInp').value;
    
    if(!task || !ans || points.length < 3) return alert("Заполните всё и обведите область!");
    
    regions.push({ task, answer: ans, color, points: [...points] });
    points = [];
    document.getElementById('taskInp').value = "";
    document.getElementById('ansInp').value = "";
    updateList();
    draw();
  }

  function updateList() {
    const l = document.getElementById('regList');
    l.innerHTML = regions.map((r, i) => `
      <div class="list-item">
        <b>${r.task} = ${r.answer}</b>
        <div style="width:20px; height:20px; background:${r.color}; display:inline-block; border-radius:4px; vertical-align:middle; margin-left:10px"></div>
        <button onclick="regions.splice(${i},1); updateList(); draw();" style="float:right; border:0; background:none; color:red; cursor:pointer">✖</button>
      </div>
    `).join('');
  }

  function buildGame() {
    const glow = document.getElementById('glowColor').value;
    const gameData = JSON.stringify({ regions, glow });
    
    const finalHtml = `
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
  body { margin: 0; background: transparent; font-family: sans-serif; height: 100vh; display: grid; grid-template-columns: 35% 65%; color: #fff; overflow: hidden; }
  .tasks-side { padding: 40px; display: flex; flex-direction: column; justify-content: center; }
  .task-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; display: none; animation: fadeIn 0.5s forwards; }
  .task-card.active { display: block; }
  .image-side { display: flex; align-items: center; justify-content: center; padding: 40px; }
  .frame { position: relative; line-height: 0; border-radius: 15px; box-shadow: 0 0 20px ${glow}, 0 0 40px ${glow}44; overflow: hidden; border: 2px solid ${glow}; }
  img { max-width: 100%; max-height: 80vh; display: block; }
  svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  .num-label { font-size: 24px; font-weight: 900; fill: #000; stroke: #fff; stroke-width: 1px; paint-order: stroke; cursor: pointer; transition: 0.2s; }
  .num-label:hover { transform: scale(1.2); filter: drop-shadow(0 0 5px #fff); }
  @keyframes fadeIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
</style>
</head>
<body>
  <div class="tasks-side" id="tasks"></div>
  <div class="image-side">
    <div class="frame">
      <img src="${currentImg}">
      <svg id="gameSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
    </div>
  </div>
  <script>
    const data = ${gameData};
    let currentTaskIdx = 0;
    const solved = [];

    function init() {
      renderTasks();
      renderImage();
    }

    function renderTasks() {
      const container = document.getElementById('tasks');
      container.innerHTML = data.regions.map((r, i) => \`
        <div class="task-card \${i === currentTaskIdx ? 'active' : ''}" id="t\${i}">
          <h2 style="margin:0; opacity:0.6; font-size:14px">ЗАДАНИЕ \${i+1}</h2>
          <div style="font-size:32px; font-weight:bold; margin-top:10px">\${r.task}</div>
        </div>
      \`).join('');
    }

    function renderImage() {
      const svg = document.getElementById('gameSvg');
      svg.innerHTML = data.regions.map((r, i) => {
        const isSolved = solved.includes(i);
        const center = getCenter(r.points);
        const path = r.points.map(p => p.x + ',' + p.y).join(' ');
        
        return \`
          <polygon points="\${path}" fill="\${isSolved ? r.color : 'rgba(255,255,255,0.7)'}" stroke="rgba(0,0,0,0.1)" />
          \${!isSolved ? \`<text x="\${center.x}" y="\${center.y}" class="num-label" text-anchor="middle" dominant-baseline="middle" onclick="clickPart(\${i})">\${r.answer}</text>\` : ''}
        \`;
      }).join('');
    }

    function getCenter(pts) {
      let x = pts.reduce((s, p) => s + p.x, 0) / pts.length;
      let y = pts.reduce((s, p) => s + p.y, 0) / pts.length;
      return {x, y};
    }

    window.clickPart = (idx) => {
      if(idx !== currentTaskIdx) return; // Можно нажать только текущее задание
      solved.push(idx);
      currentTaskIdx++;
      if(currentTaskIdx >= data.regions.length) {
         // Конец игры
      }
      renderTasks();
      renderImage();
    };
    init();
  <\/script>
</body>
</html>`;

    const blob = new Blob([finalHtml], {type: 'text/html'});
    const embedCode = `<iframe srcdoc="${finalHtml.replace(/"/g, '&quot;')}" width="100%" height="600" style="border:0;" allowtransparent="true" allowfullscreen></iframe>`;
    document.getElementById('output').value = embedCode;
  }
</script>
</body>
</html>
