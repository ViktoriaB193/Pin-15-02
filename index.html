<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Редактор раскраски v2</title>
<style>
  :root{
    --text:#eef3ff; --muted:rgba(238,243,255,.72);
    --ok:#28d7a7; --bad:#ff4d6d; --line:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 800px at 20% 10%, rgba(42,234,200,.18), transparent 50%),
                radial-gradient(1200px 800px at 90% 90%, rgba(122,166,255,.22), transparent 45%),
                linear-gradient(180deg, #050817, #0b1020 55%, #050817);
    overflow:hidden;
  }
  .app{height:100%; display:grid; grid-template-columns:420px 1fr; gap:14px; padding:14px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
    overflow:hidden; min-height:0;
  }
  .left{display:flex; flex-direction:column}
  .head{padding:14px 14px 10px; border-bottom:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.12)}
  .title{font-weight:900; font-size:18px}
  .sub{margin-top:6px; font-size:12.5px; color:rgba(238,243,255,.75); line-height:1.35}
  .scroll{padding:14px; overflow:auto; min-height:0}
  .sec{margin-bottom:14px; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; background:rgba(0,0,0,.12)}
  .sec h3{margin:0 0 10px; font-size:12px; letter-spacing:.4px; text-transform:uppercase; color:rgba(238,243,255,.78)}
  label{display:block; margin:10px 0 6px; font-size:12.5px; color:rgba(238,243,255,.78)}
  input[type="text"], textarea, select{
    width:100%; padding:10px 12px;
    border-radius:12px; border:1px solid rgba(255,255,255,.12);
    background:rgba(10,16,35,.65); color:var(--text); outline:none;
  }
  textarea{min-height:110px; resize:vertical}
  input[type="text"]:focus, textarea:focus, select:focus{
    border-color:rgba(122,166,255,.55); box-shadow:0 0 0 3px rgba(122,166,255,.16)
  }
  .btnRow{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
  .btn{
    border:0; cursor:pointer; user-select:none;
    padding:10px 12px; border-radius:12px;
    font-weight:900;
    background:linear-gradient(90deg, rgba(40,215,167,1), rgba(42,234,200,1));
    color:#07101d;
    box-shadow:0 10px 30px rgba(40,215,167,.18);
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{
    color:var(--text); background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12); box-shadow:none;
  }
  .btn.danger{
    color:#fff;
    background:linear-gradient(90deg, rgba(255,77,109,1), rgba(255,110,133,1));
    box-shadow:0 10px 30px rgba(255,77,109,.18);
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .hint{margin-top:8px; font-size:12.5px; color:rgba(238,243,255,.68); line-height:1.35}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:7px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.15);
        color:rgba(238,243,255,.78); font-weight:800; font-size:12.5px}
  .sw{width:14px; height:14px; border-radius:4px; border:1px solid rgba(255,255,255,.18)}
  .list{display:flex; flex-direction:column; gap:8px; max-height:210px; overflow:auto; padding-right:4px}
  .item{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px; border-radius:12px;
    border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10);
    cursor:pointer;
  }
  .item.active{border-color:rgba(122,166,255,.55); box-shadow:0 0 0 3px rgba(122,166,255,.12)}
  .name{font-weight:900; font-size:13px}
  .meta{font-size:12px; color:rgba(238,243,255,.65); margin-top:2px}
  .chip{font-size:11px; color:rgba(238,243,255,.7); padding:4px 8px; border-radius:999px;
        border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.12); max-width:120px;
        overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .colorRow{display:grid; grid-template-columns:84px 1fr; gap:10px; align-items:center}
  input[type="color"]{
    width:84px; height:40px; border-radius:12px;
    border:1px solid rgba(255,255,255,.12); background:rgba(10,16,35,.65); padding:0;
  }
  .right{display:grid; grid-template-rows:1fr 280px; gap:14px; min-height:0}
  .stage{padding:10px}
  .stageBox{
    height:100%; border-radius:18px; overflow:hidden;
    background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,.08);
    position:relative;
    display:flex; align-items:center; justify-content:center;
    padding:10px;
  }
  .frame{
    width:100%; max-width:980px; aspect-ratio:16/9;
    border-radius:18px; overflow:hidden; position:relative;
    box-shadow: 0 0 40px rgba(0,0,0,0.5);
    border:1px solid rgba(255,255,255,.1);
  }
  .frame img{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:contain; pointer-events:none;
  }
  .frame svg{
    position:absolute; inset:0; width:100%; height:100%;
    touch-action:none; overflow:visible; cursor: crosshair;
  }
  .empty{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    text-align:center; padding:30px;
    color:rgba(238,243,255,.65); font-weight:900;
    pointer-events:none;
  }
  .preview{padding:10px}
  iframe{width:100%; height:100%; border:0; border-radius:18px; background: #050817;}
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:rgba(8,12,24,.92); border:1px solid rgba(255,255,255,.12);
    border-radius:14px; padding:10px 12px;
    display:flex; align-items:center; gap:10px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
    opacity:0; pointer-events:none;
    transition:0.2s; z-index:999999;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}
  .dot{width:10px; height:10px; border-radius:999px; background:var(--ok)}
  .dot.bad{background:var(--bad)}
</style>
</head>
<body>
<div class="app">
  <div class="card left">
    <div class="head">
      <div class="title">Редактор раскраски</div>
      <div class="sub">Создай интерактивную игру: обведи области и привяжи их к правильным ответам.</div>
    </div>

    <div class="scroll">
      <div class="sec">
        <h3>1. Картинка</h3>
        <select id="preset">
          <option value="https://i.ibb.co/B5wHGTfh/d5e6afa4-eef8-4359-bc47-7ca55574f6ed.jpg">Котик с шариками</option>
          <option value="__custom__">Своя ссылка или файл...</option>
        </select>
        <input id="imgUrl" type="text" placeholder="https://..." style="margin-top:8px"/>
        <label>Загрузить файл</label>
        <input id="filePick" type="file" accept="image/*"/>
        <div class="btnRow">
          <button class="btn" id="btnLoad">Загрузить</button>
        </div>
      </div>

      <div class="sec">
        <h3>2. Обводка</h3>
        <div class="btnRow">
          <button class="btn secondary" id="btnUndo">Шаг назад</button>
          <button class="btn danger" id="btnClear">Сброс</button>
        </div>
        <div class="hint">Кликай по картинке, чтобы создать контур области.</div>
        <div class="btnRow" style="margin-top:12px">
           <button class="btn" id="btnSaveRegion">Создать область из точек</button>
        </div>
      </div>

      <div class="sec">
        <h3>3. Параметры области</h3>
        <label>Ответ (число или текст)</label>
        <input id="fldAnswer" type="text" placeholder="Например: 12"/>
        <label>Цвет закраски</label>
        <div class="colorRow">
          <input id="fldColor" type="color" value="#28d7a7"/>
          <input id="fldColorHex" type="text" value="#28d7a7"/>
        </div>
        <div class="btnRow">
          <button class="btn" id="btnApply">Применить к выбранной</button>
        </div>
      </div>

      <div class="sec">
        <h3>4. Список областей</h3>
        <div class="list" id="regionsList"></div>
        <div class="btnRow">
          <button class="btn danger" id="btnDelete">Удалить</button>
        </div>
      </div>

      <div class="sec">
        <h3>5. Задания (Пример | Ответ)</h3>
        <textarea id="tasksText">2 + 2 | 4 | #28d7a7
5 * 3 | 15 | #ff4d6d
10 - 5 | 5 | #7aa6ff</textarea>
      </div>

      <div class="sec">
        <h3>6. Экспорт</h3>
        <div class="btnRow">
          <button class="btn" id="btnMakeEmbed">Сгенерировать код</button>
          <button class="btn secondary" id="btnCopyEmbed">Копировать</button>
        </div>
        <textarea id="embedOut" readonly style="margin-top:10px; font-size:10px; height:60px"></textarea>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="card stage">
      <div class="stageBox">
        <div class="frame" id="frame">
          <img id="img" src="https://i.ibb.co/B5wHGTfh/d5e6afa4-eef8-4359-bc47-7ca55574f6ed.jpg" crossorigin="anonymous"/>
          <svg id="svg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
          <div class="empty" id="empty" style="display:none">Загрузите изображение</div>
        </div>
      </div>
    </div>
    <div class="card preview">
      <iframe id="gamePreview"></iframe>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="dot" id="tdot"></div><div id="tmsg"></div></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const state = {
    imgLoaded: true,
    points: [],
    regions: [],
    selectedId: null,
    imageSrc: "https://i.ibb.co/B5wHGTfh/d5e6afa4-eef8-4359-bc47-7ca55574f6ed.jpg"
  };

  const toast = (msg, kind="ok") => {
    $("tmsg").textContent = msg;
    $("tdot").className = "dot " + (kind === "bad" ? "bad" : "");
    $("toast").classList.add("show");
    setTimeout(() => $("toast").classList.remove("show"), 2000);
  };

  const render = () => {
    const svg = $("svg");
    svg.innerHTML = "";
    
    // Отрисовка сохраненных областей
    state.regions.forEach(r => {
      const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
      const pts = r.points.map(p => `${p.x},${p.y}`).join(" ");
      poly.setAttribute("points", pts);
      poly.setAttribute("fill", r.id === state.selectedId ? r.color : "rgba(255,255,255,0.1)");
      poly.setAttribute("stroke", r.id === state.selectedId ? "#fff" : "rgba(255,255,255,0.3)");
      poly.setAttribute("stroke-width", "2");
      poly.style.cursor = "pointer";
      poly.onclick = (e) => { e.stopPropagation(); selectRegion(r.id); };
      svg.appendChild(poly);
    });

    // Отрисовка текущей линии обводки
    if (state.points.length > 0) {
      const line = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
      line.setAttribute("points", state.points.map(p => `${p.x},${p.y}`).join(" "));
      line.setAttribute("fill", "none");
      line.setAttribute("stroke", "#28d7a7");
      line.setAttribute("stroke-width", "3");
      svg.appendChild(line);
      
      state.points.forEach(p => {
        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", p.x); c.setAttribute("cy", p.y); c.setAttribute("r", "5");
        c.setAttribute("fill", "#28d7a7");
        svg.appendChild(c);
      });
    }
    updateList();
  };

  const updateList = () => {
    const list = $("regionsList");
    list.innerHTML = "";
    state.regions.forEach(r => {
      const div = document.createElement("div");
      div.className = "item " + (r.id === state.selectedId ? "active" : "");
      div.innerHTML = `<span class="sw" style="background:${r.color}"></span> <span class="name">Ответ: ${r.answer}</span>`;
      div.onclick = () => selectRegion(r.id);
      list.appendChild(div);
    });
  };

  const selectRegion = (id) => {
    state.selectedId = id;
    const r = state.regions.find(x => x.id === id);
    if(r) {
      $("fldAnswer").value = r.answer;
      $("fldColor").value = r.color;
      $("fldColorHex").value = r.color;
    }
    render();
  };

  $("svg").onmousedown = (e) => {
    const rect = $("svg").getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 1000;
    const y = ((e.clientY - rect.top) / rect.height) * 1000;
    state.points.push({x, y});
    render();
  };

  $("btnSaveRegion").onclick = () => {
    if(state.points.length < 3) return toast("Нужно хотя бы 3 точки!", "bad");
    const id = "R" + Math.random().toString(16).slice(2);
    state.regions.push({
      id,
      points: [...state.points],
      answer: $("fldAnswer").value || "?",
      color: $("fldColor").value
    });
    state.points = [];
    state.selectedId = id;
    render();
    toast("Область добавлена");
  };

  $("btnApply").onclick = () => {
    const r = state.regions.find(x => x.id === state.selectedId);
    if(!r) return;
    r.answer = $("fldAnswer").value;
    r.color = $("fldColor").value;
    render();
    toast("Обновлено");
  };

  $("btnDelete").onclick = () => {
    state.regions = state.regions.filter(r => r.id !== state.selectedId);
    state.selectedId = null;
    render();
  };

  $("btnUndo").onclick = () => { state.points.pop(); render(); };
  $("btnClear").onclick = () => { state.points = []; render(); };

  $("btnLoad").onclick = () => {
    const file = $("filePick").files[0];
    if(file) {
      state.imageSrc = URL.createObjectURL(file);
    } else {
      state.imageSrc = $("imgUrl").value || state.imageSrc;
    }
    $("img").src = state.imageSrc;
    toast("Изображение обновлено");
  };

  // Генератор HTML для Genially
  const buildGameHtml = () => {
    const tasks = $("tasksText").value.split("\n").map(l => {
      const [p, a, c] = l.split("|").map(s => s.trim());
      return { prompt: p, answer: a, color: c || "#28d7a7" };
    });

    const config = {
      image: state.imageSrc,
      regions: state.regions,
      tasks: tasks
    };

    return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { margin: 0; font-family: sans-serif; background: #0b1020; color: #fff; overflow: hidden; height: 100vh; display: flex; }
        .ui { width: 300px; padding: 20px; border-right: 1px solid #333; }
        .game { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        .frame { width: 90%; aspect-ratio: 16/9; position: relative; }
        img { width: 100%; height: 100%; object-fit: contain; }
        svg { position: absolute; inset: 0; width: 100%; height: 100%; }
        input { width: 100%; padding: 10px; border-radius: 8px; border: none; margin: 10px 0; }
        button { width: 100%; padding: 10px; background: #28d7a7; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .task { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="ui">
        <div class="task" id="taskDisp"></div>
        <input type="text" id="ansInp" placeholder="Твой ответ...">
        <button onclick="check()">Проверить</button>
        <p id="msg"></p>
    </div>
    <div class="game">
        <div class="frame">
            <img src="${config.image}">
            <svg id="gameSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
        </div>
    </div>
    <script>
        const config = ${JSON.stringify(config)};
        let currentTaskIdx = 0;
        let solvedAnswers = new Set();

        function render() {
            const svg = document.getElementById("gameSvg");
            svg.innerHTML = "";
            config.regions.forEach(r => {
                const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                poly.setAttribute("points", r.points.map(p => p.x + "," + p.y).join(" "));
                poly.setAttribute("fill", solvedAnswers.has(r.answer) ? r.color : "transparent");
                poly.setAttribute("stroke", "rgba(255,255,255,0.2)");
                svg.appendChild(poly);
            });
            document.getElementById("taskDisp").textContent = config.tasks[currentTaskIdx].prompt;
        }

        function check() {
            const val = document.getElementById("ansInp").value.trim();
            const correct = config.tasks[currentTaskIdx].answer;
            if(val == correct) {
                solvedAnswers.add(correct);
                document.getElementById("msg").textContent = "Верно!";
                document.getElementById("ansInp").value = "";
                if(currentTaskIdx < config.tasks.length - 1) currentTaskIdx++;
                render();
            } else {
                document.getElementById("msg").textContent = "Попробуй еще раз";
            }
        }
        render();
    <\/script>
</body>
</html>`;
  };

  $("btnMakeEmbed").onclick = () => {
    const html = buildGameHtml();
    $("embedOut").value = html;
    const blob = new Blob([html], {type: 'text/html'});
    $("gamePreview").src = URL.createObjectURL(blob);
    toast("Код готов и загружен в предпросмотр");
  };

  $("btnCopyEmbed").onclick = () => {
    $("embedOut").select();
    document.execCommand("copy");
    toast("Скопировано!");
  };

  render();
})();
</script>
</body>
</html>
