<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞—Å–∫—Ä–∞—Å–∫–∏</title>
<style>
  :root{
    --text:#eef3ff; --muted:rgba(238,243,255,.72);
    --ok:#28d7a7; --bad:#ff4d6d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 800px at 20% 10%, rgba(42,234,200,.18), transparent 50%),
                radial-gradient(1200px 800px at 90% 90%, rgba(122,166,255,.22), transparent 45%),
                linear-gradient(180deg, #050817, #0b1020 55%, #050817);
    overflow:hidden;
  }
  .app{height:100%; display:grid; grid-template-columns:420px 1fr; gap:14px; padding:14px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
    overflow:hidden; min-height:0;
  }
  .left{display:flex; flex-direction:column}
  .head{padding:14px 14px 10px; border-bottom:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.12)}
  .title{font-weight:900; font-size:18px}
  .sub{margin-top:6px; font-size:12.5px; color:rgba(238,243,255,.75); line-height:1.35}
  .scroll{padding:14px; overflow:auto; min-height:0}
  .sec{margin-bottom:14px; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; background:rgba(0,0,0,.12)}
  .sec h3{margin:0 0 10px; font-size:12px; letter-spacing:.4px; text-transform:uppercase; color:rgba(238,243,255,.78)}
  label{display:block; margin:10px 0 6px; font-size:12.5px; color:rgba(238,243,255,.78)}
  input[type="text"], textarea, select{
    width:100%; padding:10px 12px;
    border-radius:12px; border:1px solid rgba(255,255,255,.12);
    background:rgba(10,16,35,.65); color:var(--text); outline:none;
  }
  textarea{min-height:110px; resize:vertical}
  .btnRow{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
  .btn{
    border:0; cursor:pointer; user-select:none;
    padding:10px 12px; border-radius:12px;
    font-weight:900;
    background:linear-gradient(90deg, rgba(40,215,167,1), rgba(42,234,200,1));
    color:#07101d;
    box-shadow:0 10px 30px rgba(40,215,167,.18);
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{
    color:var(--text); background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12); box-shadow:none;
  }
  .btn.danger{
    color:#fff;
    background:linear-gradient(90deg, rgba(255,77,109,1), rgba(255,110,133,1));
    box-shadow:0 10px 30px rgba(255,77,109,.18);
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .hint{margin-top:8px; font-size:12.5px; color:rgba(238,243,255,.68); line-height:1.35}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:7px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.15);
        color:rgba(238,243,255,.78); font-weight:800; font-size:12.5px}
  .sw{width:14px; height:14px; border-radius:4px; border:1px solid rgba(255,255,255,.18)}
  .list{display:flex; flex-direction:column; gap:8px; max-height:210px; overflow:auto; padding-right:4px}
  .item{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px; border-radius:12px;
    border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10);
    cursor:pointer;
  }
  .item.active{border-color:rgba(122,166,255,.55); box-shadow:0 0 0 3px rgba(122,166,255,.12)}
  .name{font-weight:900; font-size:13px}
  .meta{font-size:12px; color:rgba(238,243,255,.65); margin-top:2px}
  .chip{font-size:11px; color:rgba(238,243,255,.7); padding:4px 8px; border-radius:999px;
        border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.12); max-width:120px;
        overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .colorRow{display:grid; grid-template-columns:84px 1fr; gap:10px; align-items:center}
  input[type="color"]{
    width:84px; height:40px; border-radius:12px;
    border:1px solid rgba(255,255,255,.12); background:rgba(10,16,35,.65); padding:0;
  }
  .right{display:grid; grid-template-rows:1fr 280px; gap:14px; min-height:0}
  .stage{padding:10px}
  .stageBox{
    height:100%; border-radius:18px; overflow:hidden;
    background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
    position:relative;
    display:flex; align-items:center; justify-content:center;
    padding:10px;
  }
  .frame{
    width:100%; max-width:980px; aspect-ratio:16/9;
    border-radius:18px; overflow:hidden; position:relative;
    background:transparent;
    box-shadow:0 0 0 1px rgba(42,234,200,.55),
              0 0 0 3px rgba(122,166,255,.18),
              0 0 22px rgba(42,234,200,.20),
              0 0 28px rgba(122,166,255,.18);
    border:1px solid rgba(255,255,255,.08);
  }
  .frame img{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:contain; pointer-events:none; user-select:none;
    background:transparent;
  }
  .frame svg{
    position:absolute;
    inset:auto;
    width:10px; height:10px;
    touch-action:none;
    overflow:visible;
  }
  .empty{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    text-align:center; padding:30px;
    color:rgba(238,243,255,.65); font-weight:900;
    pointer-events:none;
  }
  .preview{padding:10px}
  iframe{width:100%; height:100%; border:0; border-radius:18px; background:transparent}
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:rgba(8,12,24,.92); border:1px solid rgba(255,255,255,.12);
    border-radius:14px; padding:10px 12px;
    display:flex; align-items:center; gap:10px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
    opacity:0; pointer-events:none;
    transition:opacity .18s ease, transform .18s ease;
    max-width:min(920px, calc(100% - 24px));
    font-size:13px;
    z-index:999999;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}
  .dot{width:10px; height:10px; border-radius:999px; background:var(--ok); box-shadow:0 0 0 3px rgba(40,215,167,.15)}
  .dot.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(255,77,109,.15)}
  @media (max-width:980px){
    body{overflow:auto}
    .app{grid-template-columns:1fr; height:auto}
    .right{grid-template-rows:460px 340px}
  }
</style>
</head>
<body>
<div class="app">
  <div class="card left">
    <div class="head">
      <div class="title">–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞—Å–∫—Ä–∞—Å–∫–∏</div>
      <div class="sub">–í—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Üí –æ–±–≤–µ–¥–∏ –æ–±–ª–∞—Å—Ç–∏ ‚Üí —É–∫–∞–∂–∏ –æ—Ç–≤–µ—Ç –∏ —Ü–≤–µ—Ç ‚Üí —Å–º–æ—Ç—Ä–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Üí –ø–æ–ª—É—á–∏ –∫–æ–¥ –¥–ª—è Genially.</div>
    </div>

    <div class="scroll">
      <div class="sec">
        <h3>–ö–∞—Ä—Ç–∏–Ω–∫–∞</h3>
        <label>–í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
        <select id="preset">
          <option value="https://i.ibb.co/B5wHGTfh/d5e6afa4-eef8-4359-bc47-7ca55574f6ed.jpg">–ö–æ—Ç–∏–∫ —Å —à–∞—Ä–∏–∫–∞–º–∏</option>
          <option value="__custom__">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–≤–æ—ë‚Ä¶</option>
        </select>

        <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
        <input id="imgUrl" type="text" placeholder="–í—Å—Ç–∞–≤—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É (–∏–ª–∏ HTML —Å <img src='...'>)"/>

        <div class="hint">–ï—Å–ª–∏ –≤—Å—Ç–∞–≤–ª—è–µ—à—å HTML ‚Äî —è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑—å–º—É src. –ù–∞–∂–º–∏ Enter.</div>

        <label>–∏–ª–∏ —Ñ–∞–π–ª —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</label>
        <input id="filePick" type="file" accept="image/*,.svg"/>

        <div class="btnRow">
          <button class="btn" id="btnLoad" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
          <button class="btn secondary" id="btnFit" type="button">–ü–æ–¥–æ–≥–Ω–∞—Ç—å</button>
        </div>
      </div>

      <div class="sec">
        <h3>–û–±–≤–æ–¥–∫–∞</h3>
        <div class="btnRow">
          <button class="btn secondary" id="btnUndo" type="button">–ù–∞–∑–∞–¥</button>
          <button class="btn danger" id="btnClear" type="button">–û—á–∏—Å—Ç–∏—Ç—å —Ç–æ—á–∫–∏</button>
          <button class="btn secondary" id="btnNew" type="button">–ù–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å</button>
        </div>
        <div class="btnRow" style="margin-top:12px">
          <span class="pill"><span class="sw" style="background:rgba(42,234,200,.9)"></span>–¢–æ—á–µ–∫: <span id="pointsCount">0</span></span>
          <span class="pill"><span class="sw" style="background:rgba(122,166,255,.9)"></span>–û–±–ª–∞—Å—Ç–µ–π: <span id="regionsCount">0</span></span>
        </div>
        <div class="hint">–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ ‚Äî —Ç–æ—á–∫–∞. –°–æ—Ö—Ä–∞–Ω–∏ –æ–±–ª–∞—Å—Ç—å, –∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤–æ.</div>
        <div class="btnRow" style="margin-top:12px">
          <button class="btn" id="btnSaveRegion" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–ª–∞—Å—Ç—å</button>
        </div>
      </div>

      <div class="sec">
        <h3>–°–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π</h3>
        <div class="list" id="regionsList"></div>
        <div class="btnRow" style="margin-top:10px">
          <button class="btn danger" id="btnDelete" type="button">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="btn secondary" id="btnDuplicate" type="button">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>

      <div class="sec">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–ª–∞—Å—Ç–∏</h3>
        <div class="row">
          <div>
            <label>–û—Ç–≤–µ—Ç / –Ω–æ–º–µ—Ä</label>
            <input id="fldAnswer" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5"/>
          </div>
          <div>
            <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–æ–º–µ—Ä</label>
            <select id="fldShowNumber">
              <option value="1">–î–∞</option>
              <option value="0">–ù–µ—Ç</option>
            </select>
          </div>
        </div>

        <label>–¶–≤–µ—Ç</label>
        <div class="colorRow">
          <input id="fldColor" type="color" value="#ff4d6d"/>
          <input id="fldColorHex" type="text" value="#ff4d6d"/>
        </div>

        <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</label>
        <input id="fldAlpha" type="range" min="0.15" max="1" step="0.01" value="0.55"/>

        <div class="btnRow">
          <button class="btn" id="btnApply" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn secondary" id="btnShow" type="button">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
      </div>

      <div class="sec">
        <h3>–ó–∞–¥–∞–Ω–∏—è (–ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)</h3>
        <div class="hint">–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ = –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ. –§–æ—Ä–º–∞—Ç: <b>–ø—Ä–∏–º–µ—Ä | –æ—Ç–≤–µ—Ç | —Ü–≤–µ—Ç</b>. –¶–≤–µ—Ç –º–æ–∂–Ω–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å.</div>
        <textarea id="tasksText"></textarea>
      </div>

      <div class="sec">
        <h3>Genially</h3>
        <div class="btnRow">
          <button class="btn secondary" id="btnRefreshPreview" type="button">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button class="btn" id="btnMakeEmbed" type="button">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
          <button class="btn secondary" id="btnCopyEmbed" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <label style="margin-top:12px">–ö–æ–¥ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ Genially</label>
        <textarea id="embedOut" readonly></textarea>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="card stage">
      <div class="stageBox">
        <div class="frame" id="frame">
          <img id="img" alt=""/>
          <svg id="svg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
          <div class="empty" id="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏.<br/>–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª –∏–ª–∏ –≤—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É.</div>
        </div>
      </div>
    </div>

    <div class="card preview">
      <iframe id="gamePreview" title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–≥—Ä—ã"></iframe>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="dot" id="tdot"></div><div id="tmsg"></div></div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const DEFAULT_URL = "https://i.ibb.co/B5wHGTfh/d5e6afa4-eef8-4359-bc47-7ca55574f6ed.jpg";

  const els = {
    preset:$("preset"), imgUrl:$("imgUrl"), filePick:$("filePick"),
    btnLoad:$("btnLoad"), btnFit:$("btnFit"),
    btnUndo:$("btnUndo"), btnClear:$("btnClear"), btnNew:$("btnNew"),
    btnSaveRegion:$("btnSaveRegion"),
    pointsCount:$("pointsCount"), regionsCount:$("regionsCount"),
    regionsList:$("regionsList"),
    btnDelete:$("btnDelete"), btnDuplicate:$("btnDuplicate"),
    fldAnswer:$("fldAnswer"), fldColor:$("fldColor"), fldColorHex:$("fldColorHex"),
    fldAlpha:$("fldAlpha"), fldShowNumber:$("fldShowNumber"),
    btnApply:$("btnApply"), btnShow:$("btnShow"),
    tasksText:$("tasksText"),
    btnRefreshPreview:$("btnRefreshPreview"),
    btnMakeEmbed:$("btnMakeEmbed"),
    btnCopyEmbed:$("btnCopyEmbed"),
    embedOut:$("embedOut"),
    img:$("img"), svg:$("svg"), empty:$("empty"),
    gamePreview:$("gamePreview"),
    toast:$("toast"), tdot:$("tdot"), tmsg:$("tmsg"),
    frame:$("frame")
  };

  const state = {
    imageUrl: DEFAULT_URL,
    imageDataUrl: "",
    imgLoaded: false,
    points: [],
    regions: [],
    selectedId: null,
    objectUrl: null
  };

  // toast
  let toastTimer=null;
  const toast=(msg,kind="ok")=>{
    els.tmsg.textContent=msg;
    els.tdot.classList.toggle("bad", kind==="bad");
    els.toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>els.toast.classList.remove("show"), 2600);
  };

  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const uid=()=>("R"+Math.random().toString(16).slice(2,10));

  const extractUrl=(text)=>{
    const t=(text||"").trim();
    if(!t) return "";
    if(/^https?:\/\/\S+$/i.test(t)) return t;
    const m1=t.match(/src\s*=\s*["']([^"']+)["']/i);
    if(m1 && m1[1]) return m1[1].trim();
    const m3=t.match(/https?:\/\/[^\s"'<>]+/i);
    if(m3 && m3[0]) return m3[0];
    return "";
  };

  const hexNormalize=(h)=>{
    let x=(h||"").trim();
    if(!x) return "";
    if(x[0]!=="#") x="#"+x;
    if(!/^#[0-9a-f]{3}([0-9a-f]{3})?$/i.test(x)) return "";
    if(x.length===4) x="#"+x[1]+x[1]+x[2]+x[2]+x[3]+x[3];
    return x.toLowerCase();
  };

  const svgEl=(tag,attrs)=>{
    const n=document.createElementNS("http://www.w3.org/2000/svg",tag);
    for(const k in attrs) n.setAttribute(k,String(attrs[k]));
    return n;
  };

  const polygonCentroid=(pts)=>{
    if(!pts||pts.length<3){
      const ax=pts.reduce((s,p)=>s+p.x,0)/Math.max(1,pts.length);
      const ay=pts.reduce((s,p)=>s+p.y,0)/Math.max(1,pts.length);
      return {x:ax||500,y:ay||500};
    }
    let area=0,cx=0,cy=0;
    for(let i=0;i<pts.length;i++){
      const p1=pts[i], p2=pts[(i+1)%pts.length];
      const a=p1.x*p2.y - p2.x*p1.y;
      area+=a; cx+=(p1.x+p2.x)*a; cy+=(p1.y+p2.y)*a;
    }
    area*=0.5;
    if(Math.abs(area)<1e-6) return {x:500,y:500};
    cx/=(6*area); cy/=(6*area);
    return {x:cx,y:cy};
  };

  const hexToRgb=(hex)=>{
    const h=hexNormalize(hex)||"#ff4d6d";
    const r=parseInt(h.slice(1,3),16), g=parseInt(h.slice(3,5),16), b=parseInt(h.slice(5,7),16);
    return `${r},${g},${b}`;
  };

  // contain-box
  const calcContainBox = ()=>{
    const fr = els.frame.getBoundingClientRect();
    const iw = els.img.naturalWidth || 1;
    const ih = els.img.naturalHeight || 1;
    const fw = fr.width, fh = fr.height;

    const imgRatio = iw/ih;
    const frameRatio = fw/fh;

    let w,h,x,y;
    if(imgRatio > frameRatio){
      w = fw; h = fw / imgRatio;
      x = 0; y = (fh - h)/2;
    }else{
      h = fh; w = fh * imgRatio;
      y = 0; x = (fw - w)/2;
    }

    Object.assign(els.svg.style, {
      left: x + "px",
      top: y + "px",
      width: w + "px",
      height: h + "px",
      position: "absolute"
    });
  };

  const renderOverlay=()=>{
    while(els.svg.firstChild) els.svg.removeChild(els.svg.firstChild);

    for(const r of state.regions){
      const pts=(r.points||[]).map(p=>`${p.x},${p.y}`).join(" ");
      const fill=`rgba(${hexToRgb(r.color||"#ff4d6d")},${clamp(r.alpha ?? 0.55,0,1)})`;
      const poly=svgEl("polygon",{points:pts, fill: r.paintedPreview?fill:"rgba(0,0,0,0)"});
      poly.style.cursor="pointer";
      poly.addEventListener("click",(e)=>{e.preventDefault();e.stopPropagation();selectRegion(r.id);});
      els.svg.appendChild(poly);

      if(r.id===state.selectedId){
        const outline=svgEl("polygon",{points:pts, fill:"rgba(0,0,0,0)", stroke:"rgba(122,166,255,.95)","stroke-width":2});
        outline.setAttribute("stroke-linejoin","round");
        outline.setAttribute("stroke-linecap","round");
        els.svg.appendChild(outline);
      }

      if(r.showNumber){
        const c=polygonCentroid(r.points);
        const t=svgEl("text",{x:c.x,y:c.y,"text-anchor":"middle","dominant-baseline":"middle","font-size":32,"font-weight":900,
          fill:"rgba(10,16,35,.92)",stroke:"rgba(255,255,255,.85)","stroke-width":4,"paint-order":"stroke"});
        t.textContent=r.answer??"";
        els.svg.appendChild(t);
      }
    }

    if(state.points.length){
      const pl=svgEl("polyline",{points:state.points.map(p=>`${p.x},${p.y}`).join(" "),
        fill:"rgba(0,0,0,0)", stroke:"rgba(40,215,167,.95)","stroke-width":3});
      pl.setAttribute("stroke-linejoin","round"); pl.setAttribute("stroke-linecap","round");
      els.svg.appendChild(pl);

      state.points.forEach((p)=>{
        const c=svgEl("circle",{cx:p.x,cy:p.y,r:6, fill:"rgba(40,215,167,.95)",
          stroke:"rgba(255,255,255,.85)","stroke-width":2});
        els.svg.appendChild(c);
      });
    }

    els.pointsCount.textContent=String(state.points.length);
    els.regionsCount.textContent=String(state.regions.length);
  };

  const renderList=()=>{
    els.regionsList.innerHTML="";
    if(!state.regions.length){
      const d=document.createElement("div");
      d.style.color="rgba(238,243,255,.65)";
      d.style.fontSize="12.5px";
      d.textContent="–ü–æ–∫–∞ –Ω–µ—Ç –æ–±–ª–∞—Å—Ç–µ–π. –û–±–≤–µ–¥–∏ –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–ª–∞—Å—Ç—å¬ª.";
      els.regionsList.appendChild(d);
      return;
    }
    state.regions.forEach((r,idx)=>{
      const it=document.createElement("div");
      it.className="item"+(r.id===state.selectedId?" active":"");
      it.addEventListener("click",()=>selectRegion(r.id));

      const left=document.createElement("div"); left.style.display="flex"; left.style.gap="10px"; left.style.alignItems="center";
      const sw=document.createElement("div"); sw.className="sw"; sw.style.background=r.color||"#ff4d6d"; left.appendChild(sw);

      const meta=document.createElement("div");
      const nm=document.createElement("div"); nm.className="name"; nm.textContent=`–û–±–ª–∞—Å—Ç—å ${idx+1}${r.answer?(" ‚Ä¢ "+r.answer):""}`;
      const mm=document.createElement("div"); mm.className="meta"; mm.textContent=`${(r.points||[]).length} —Ç–æ—á–µ–∫`;
      meta.appendChild(nm); meta.appendChild(mm);
      left.appendChild(meta);

      const chip=document.createElement("div"); chip.className="chip"; chip.textContent=r.id;

      it.appendChild(left); it.appendChild(chip);
      els.regionsList.appendChild(it);
    });
  };

  const selectRegion=(id)=>{
    state.selectedId=id;
    const r=state.regions.find(x=>x.id===id);
    if(!r){renderList();renderOverlay();return;}
    els.fldAnswer.value=r.answer??"";
    els.fldColor.value=r.color||"#ff4d6d";
    els.fldColorHex.value=r.color||"#ff4d6d";
    els.fldAlpha.value=String(r.alpha ?? 0.55);
    els.fldShowNumber.value=r.showNumber?"1":"0";
    state.regions.forEach(rr=>rr.paintedPreview=false);
    r.paintedPreview=true;
    renderList(); renderOverlay();
  };

  const svgToNorm=(e)=>{
    const rect=els.svg.getBoundingClientRect();
    const x=(e.clientX-rect.left)/rect.width;
    const y=(e.clientY-rect.top)/rect.height;
    return {x:clamp(x,0,1)*1000, y:clamp(y,0,1)*1000};
  };

  const addPoint=(e)=>{
    if(!state.imgLoaded) return;
    const p=svgToNorm(e);
    state.points.push(p);
    renderOverlay();
  };

  const undoPoint=()=>{ if(state.points.length){ state.points.pop(); renderOverlay(); } };
  const clearPoints=()=>{ state.points=[]; renderOverlay(); };

  const newOutline=()=>{
    state.points=[]; state.selectedId=null;
    state.regions.forEach(rr=>rr.paintedPreview=false);
    renderList(); renderOverlay();
  };

  const saveRegion=()=>{
    if(state.points.length<3){ toast("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏.","bad"); return; }
    const answer=(els.fldAnswer.value||"").trim();
    if(!answer){ toast("–£–∫–∞–∂–∏ –æ—Ç–≤–µ—Ç/–Ω–æ–º–µ—Ä.","bad"); return; }
    const color=hexNormalize(els.fldColorHex.value) || els.fldColor.value || "#ff4d6d";
    const alpha=parseFloat(els.fldAlpha.value||"0.55");
    const showNumber=els.fldShowNumber.value==="1";

    const r={ id:uid(), points:JSON.parse(JSON.stringify(state.points)), answer, color,
      alpha: clamp(isFinite(alpha)?alpha:0.55,0.05,1), showNumber, paintedPreview:false };

    state.regions.push(r);
    state.points=[];
    state.selectedId=r.id;
    toast("–û–±–ª–∞—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.","ok");
    renderList(); selectRegion(r.id);
    refreshPreview();
  };

  const deleteSelected=()=>{
    if(!state.selectedId){ toast("–í—ã–±–µ—Ä–∏ –æ–±–ª–∞—Å—Ç—å.","bad"); return; }
    const i=state.regions.findIndex(r=>r.id===state.selectedId);
    if(i>=0){
      state.regions.splice(i,1);
      state.selectedId=null;
      state.points=[];
      toast("–£–¥–∞–ª–µ–Ω–æ.","ok");
      renderList(); renderOverlay();
      refreshPreview();
    }
  };

  const duplicateSelected=()=>{
    if(!state.selectedId){ toast("–í—ã–±–µ—Ä–∏ –æ–±–ª–∞—Å—Ç—å.","bad"); return; }
    const src=state.regions.find(r=>r.id===state.selectedId);
    if(!src) return;
    const copy=JSON.parse(JSON.stringify(src));
    copy.id=uid(); copy.paintedPreview=false;
    state.regions.push(copy);
    state.selectedId=copy.id;
    toast("–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–æ.","ok");
    renderList(); selectRegion(copy.id);
    refreshPreview();
  };

  const applyFields=()=>{
    if(!state.selectedId){ toast("–í—ã–±–µ—Ä–∏ –æ–±–ª–∞—Å—Ç—å.","bad"); return; }
    const r=state.regions.find(x=>x.id===state.selectedId);
    if(!r) return;
    r.answer=(els.fldAnswer.value||"").trim();
    if(!r.answer){ toast("–û—Ç–≤–µ—Ç/–Ω–æ–º–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.","bad"); return; }
    r.color=hexNormalize(els.fldColorHex.value) || els.fldColor.value || "#ff4d6d";
    r.alpha=clamp(parseFloat(els.fldAlpha.value||"0.55"),0.05,1);
    r.showNumber=els.fldShowNumber.value==="1";
    toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.","ok");
    renderList(); renderOverlay();
    refreshPreview();
  };

  const showSelectedPreview=()=>{
    if(!state.selectedId){ toast("–í—ã–±–µ—Ä–∏ –æ–±–ª–∞—Å—Ç—å.","bad"); return; }
    state.regions.forEach(rr=>rr.paintedPreview=false);
    const r=state.regions.find(x=>x.id===state.selectedId);
    if(r) r.paintedPreview=true;
    renderOverlay();
  };

  // ---- –ù–∞–¥—ë–∂–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: 1) createObjectURL, 2) FileReader fallback ----
  const revokeObjectUrl=()=>{
    if(state.objectUrl){
      try{ URL.revokeObjectURL(state.objectUrl); }catch{}
      state.objectUrl=null;
    }
  };

  const loadImageFromSrc = (src, label)=>{
    return new Promise((resolve,reject)=>{
      state.imgLoaded=false;
      els.empty.style.display="";

      els.img.onload=null; els.img.onerror=null;

      els.img.onload=()=>{
        state.imgLoaded=true;
        els.empty.style.display="none";
        calcContainBox();
        renderOverlay();
        toast("–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ("+label+").","ok");
        refreshPreview();
        resolve(true);
      };

      els.img.onerror=()=>{
        state.imgLoaded=false;
        els.empty.style.display="";
        reject(new Error("img-load-fail"));
      };

      els.img.src="";
      els.img.src=src;
    });
  };

  const loadImage = async ()=>{
    const file = els.filePick.files && els.filePick.files[0];

    // 1) —Ñ–∞–π–ª
    if(file){
      toast("–§–∞–π–ª –≤—ã–±—Ä–∞–Ω ‚Äî –∑–∞–≥—Ä—É–∂–∞—é‚Ä¶","ok");

      // –ø—Ä–æ–±—É–µ–º —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–±
      try{
        revokeObjectUrl();
        state.objectUrl = URL.createObjectURL(file);
        state.imageDataUrl = "";
        state.imageUrl = "";
        await loadImageFromSrc(state.objectUrl, "—Ñ–∞–π–ª");
        return;
      }catch{
        // fallback –Ω–∞ FileReader
      }

      const reader=new FileReader();
      reader.onload=async ()=>{
        try{
          revokeObjectUrl();
          state.imageDataUrl=String(reader.result||"");
          state.imageUrl="";
          await loadImageFromSrc(state.imageDataUrl, "—Ñ–∞–π–ª");
        }catch{
          toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä (Chrome).","bad");
        }
      };
      reader.onerror=()=>toast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π Chrome.","bad");
      reader.readAsDataURL(file);
      return;
    }

    // 2) —Å—Å—ã–ª–∫–∞ / HTML
    const raw = els.imgUrl.value || "";
    const url = extractUrl(raw);
    if(!url){ toast("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª.","bad"); return; }

    try{
      revokeObjectUrl();
      state.imageUrl=url;
      state.imageDataUrl="";
      await loadImageFromSrc(url, "—Å—Å—ã–ª–∫–∞");
    }catch{
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ. –ù—É–∂–Ω–∞ –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª.","bad");
    }
  };

  const fit=()=>{
    if(!state.imgLoaded){ toast("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É.","bad"); return; }
    calcContainBox();
    toast("–ü–æ–¥–æ–≥–Ω–∞–Ω–æ.","ok");
  };

  // tasks
  const defaultTasks = [
    "2 √ó 6 = ? | 12 | #ff4d6d",
    "7 √ó 2 = ? | 14 | #ffd166",
    "9 √ó 2 = ? | 18 | #7aa6ff",
    "3 √ó 5 = ? | 15 | #2aeac8",
    "4 √ó 4 = ? | 16 | #b8ff7a",
    "10 ‚àí 5 = ? | 5 | #c77dff",
    "8 ‚àí 3 = ? | 5 | #c77dff",
    "6 ‚àí 1 = ? | 5 | #c77dff",
    "9 ‚àí 4 = ? | 5 | #c77dff",
    "7 ‚àí 2 = ? | 5 | #c77dff"
  ].join("\n");

  const parseTasks = ()=>{
    const lines = (els.tasksText.value||"").split("\n").map(s=>s.trim()).filter(Boolean);
    const out = [];
    for(const line of lines){
      const parts=line.split("|").map(s=>s.trim());
      if(parts.length<2) continue;
      const prompt=parts[0];
      const answer=parts[1];
      const color=hexNormalize(parts[2]||"") || "#ff4d6d";
      out.push({prompt, answer, color});
    }
    return out;
  };

  const buildPayload=()=>{
    if(!state.imgLoaded) throw new Error("no-image");
    if(!state.regions.length) throw new Error("no-regions");
    const tasks=parseTasks();
    if(!tasks.length) throw new Error("no-tasks");

    const imageSrc = state.imageDataUrl || state.imageUrl || state.objectUrl || DEFAULT_URL;

    const regionAnswers = new Set(state.regions.map(r=>String((r.answer||"").trim())));
    const taskAnswers = new Set(tasks.map(t=>String((t.answer||"").trim())));
    const missing=[];
    regionAnswers.forEach(a=>{ if(a && !taskAnswers.has(a)) missing.push(a); });

    return {
      version:2,
      imageSrc,
      regions: state.regions.map(r=>({
        id:r.id,
        points:r.points,
        answer:String((r.answer||"").trim()),
        color:r.color||"#ff4d6d",
        alpha:clamp(r.alpha ?? 0.55,0.05,1),
        showNumber:!!r.showNumber
      })),
      tasks,
      _missingAnswers: missing
    };
  };

  // game (–≤–æ–ø—Ä–æ—Å—ã –ù–ï –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è, –ø–æ –ø–æ—Ä—è–¥–∫—É; –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ=5 –∫—Ä–∞—Å–∏–º –≤—Å–µ –æ–±–ª–∞—Å—Ç–∏ —Å 5 —Å—Ä–∞–∑—É)
  const buildGameHtml=(payload)=>{
    const data=JSON.stringify(payload).replace(/</g,"\\u003c");
    return `<!doctype html>
<html lang="ru"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–†–∞—Å–∫—Ä–∞—Å–∫–∞ –ø–æ –æ—Ç–≤–µ—Ç–∞–º</title>
<style>
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:transparent;color:#eef3ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
.wrap{height:100%;width:100%;display:grid;grid-template-columns:38% 62%}
.left{padding:32px 28px;background:transparent}
.right{display:flex;align-items:center;justify-content:center;padding:18px 18px 18px 0;background:transparent}
.t{font-weight:900;font-size:26px}.d{margin-top:10px;color:rgba(238,243,255,.72);line-height:1.35}
.q{margin-top:22px;font-size:44px;font-weight:900}
.inp{margin-top:18px;width:100%;max-width:520px;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);color:#eef3ff;outline:none;font-size:18px}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
.btn{border:0;cursor:pointer;padding:12px 18px;border-radius:14px;font-weight:900;background:linear-gradient(90deg, rgba(40,215,167,1), rgba(42,234,200,1));color:#06101c;box-shadow:0 12px 34px rgba(40,215,167,.18)}
.btn.s{background:rgba(255,255,255,.10);color:#eef3ff;box-shadow:none;border:1px solid rgba(255,255,255,.14)}
.stat{margin-top:16px;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.10);max-width:520px}
.stat strong{display:block;font-size:16px}.stat span{display:block;margin-top:4px;color:rgba(238,243,255,.72)}
.paintRow{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.h{display:none !important}
.pot{width:62px;height:62px;border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;position:relative;transform-origin:50% 80%;animation:w 1.8s ease-in-out infinite}
@keyframes w{0%,100%{transform:rotate(-2deg)}50%{transform:rotate(2deg) translateY(-1px)}}
.paint{width:26px;height:26px;border-radius:10px;border:1px solid rgba(255,255,255,.20)}
.lb{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-weight:900;font-size:12px;color:rgba(238,243,255,.80);text-shadow:0 2px 10px rgba(0,0,0,.35);pointer-events:none}
.frame{width:100%;max-width:980px;aspect-ratio:16/9;border-radius:18px;overflow:hidden;position:relative;background:transparent;box-shadow:0 0 0 1px rgba(42,234,200,.55),0 0 0 3px rgba(122,166,255,.18),0 0 22px rgba(42,234,200,.20),0 0 28px rgba(122,166,255,.18);border:1px solid rgba(255,255,255,.08)}
.frame img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none;user-select:none;background:transparent}
.frame svg{position:absolute;inset:auto;width:10px;height:10px;touch-action:none;overflow:visible}
@media (max-width:980px){body{overflow:auto}.wrap{grid-template-columns:1fr;padding:16px}.right{padding:0}}
</style></head><body>
<script id="PAYLOAD" type="application/json">${data}</script>
<div class="wrap" id="wrap">
  <div class="left" id="left">
    <div class="t">–†–∞—Å–∫—Ä–∞—Å–∫–∞ –ø–æ –æ—Ç–≤–µ—Ç–∞–º</div>
    <div class="d">–†–µ—à–∏ –ø—Ä–∏–º–µ—Ä ‚Üí –ø–æ—è–≤–∏—Ç—Å—è –∫—Ä–∞—Å–∫–∞ ‚Üí –Ω–∞–∂–º–∏ –Ω–∞ –æ–±–ª–∞—Å—Ç—å —Å —ç—Ç–∏–º –æ—Ç–≤–µ—Ç–æ–º (–∑–∞–∫—Ä–∞—Å—è—Ç—Å—è –≤—Å–µ —Å—Ä–∞–∑—É).</div>
    <div class="q" id="q">‚Äî</div>
    <input class="inp" id="a" placeholder="–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç" inputmode="numeric"/>
    <div class="row">
      <button class="btn" id="check" type="button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      <button class="btn s" id="next" type="button">–î–∞–ª—å—à–µ</button>
    </div>
    <div class="stat" id="stat">
      <strong>–ü–æ–∫–∞ –Ω–µ—Ç –∫—Ä–∞—Å–∫–∏</strong>
      <span>–°–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏ –ø—Ä–∏–º–µ—Ä.</span>
      <div class="paintRow h" id="pots"></div>
    </div>
  </div>
  <div class="right">
    <div class="frame" id="frame">
      <img id="img" alt=""/>
      <svg id="svg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
    </div>
  </div>
</div>
<script>
(()=> {
  const payload=JSON.parse(document.getElementById("PAYLOAD").textContent);
  const img=document.getElementById("img");
  const svg=document.getElementById("svg");
  const q=document.getElementById("q");
  const a=document.getElementById("a");
  const stat=document.getElementById("stat");
  const pots=document.getElementById("pots");
  const frame=document.getElementById("frame");

  const regions=payload.regions.map(r=>({...r, painted:false}));
  const tasks=payload.tasks.slice();
  let idx=0;
  let paint=null;

  const hexToRgb=(h)=>{h=(h||"").trim().toLowerCase(); if(h[0]!=="#")h="#"+h; if(h.length===4)h="#"+h[1]+h[1]+h[2]+h[2]+h[3]+h[3];
    return [parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];
  };

  const centroid=(pts)=>{ if(!pts||pts.length<3){let ax=0,ay=0; for(const p of pts){ax+=p.x;ay+=p.y} ax/=Math.max(1,pts.length); ay/=Math.max(1,pts.length); return {x:ax||500,y:ay||500};}
    let area=0,cx=0,cy=0; for(let i=0;i<pts.length;i++){const p1=pts[i],p2=pts[(i+1)%pts.length]; const a=p1.x*p2.y-p2.x*p1.y; area+=a; cx+=(p1.x+p2.x)*a; cy+=(p1.y+p2.y)*a;}
    area*=0.5; if(Math.abs(area)<1e-6) return {x:500,y:500}; cx/=(6*area); cy/=(6*area); return {x:cx,y:cy};
  };

  const calcContainBox=()=>{
    const fr=frame.getBoundingClientRect();
    const iw=img.naturalWidth||1, ih=img.naturalHeight||1;
    const fw=fr.width, fh=fr.height;
    const imgRatio=iw/ih, frameRatio=fw/fh;
    let w,h,x,y;
    if(imgRatio>frameRatio){ w=fw; h=fw/imgRatio; x=0; y=(fh-h)/2; }
    else{ h=fh; w=fh*imgRatio; y=0; x=(fw-w)/2; }
    Object.assign(svg.style,{left:x+"px", top:y+"px", width:w+"px", height:h+"px", position:"absolute"});
  };

  const clearSvg=()=>{while(svg.firstChild) svg.removeChild(svg.firstChild);};

  const render=()=>{
    clearSvg();
    for(const r of regions){
      const pts=r.points.map(p=>p.x+","+p.y).join(" ");
      const poly=document.createElementNS("http://www.w3.org/2000/svg","polygon");
      poly.setAttribute("points",pts);
      poly.style.cursor="pointer";
      if(r.painted){
        const [R,G,B]=hexToRgb(r.color||"#ff4d6d");
        poly.setAttribute("fill","rgba("+R+","+G+","+B+","+(r.alpha ?? 0.55)+")");
      }else poly.setAttribute("fill","rgba(0,0,0,0)");
      poly.addEventListener("click",(e)=>{e.preventDefault();e.stopPropagation(); onClick(r.id);});
      svg.appendChild(poly);

      if(r.showNumber && !r.painted){
        const c=centroid(r.points);
        const t=document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x",c.x); t.setAttribute("y",c.y);
        t.setAttribute("text-anchor","middle");
        t.setAttribute("dominant-baseline","middle");
        t.setAttribute("font-size","32");
        t.setAttribute("font-weight","900");
        t.setAttribute("fill","rgba(10,16,35,.92)");
        t.setAttribute("stroke","rgba(255,255,255,.9)");
        t.setAttribute("stroke-width","4");
        t.setAttribute("paint-order","stroke");
        t.textContent=(r.answer||"");
        svg.appendChild(t);
      }
    }
  };

  const setStatus=(t,s,showPots)=>{stat.querySelector("strong").textContent=t; stat.querySelector("span").textContent=s; pots.classList.toggle("h",!showPots);};
  const showPot=(ans,color)=>{
    pots.innerHTML="";
    const pot=document.createElement("div"); pot.className="pot";
    const sw=document.createElement("div"); sw.className="paint"; sw.style.background=color; pot.appendChild(sw);
    const lb=document.createElement("div"); lb.className="lb"; lb.textContent=ans; pot.appendChild(lb);
    pots.appendChild(pot);
  };

  const task=()=>tasks[idx] || null;

  const loadTask=()=>{
    const t=task();
    if(!t){
      q.textContent="‚Äî";
      a.value="";
      setStatus("–í–æ–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å","–î–æ–±–∞–≤—å –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –æ—Ç–≤–µ—Ç–æ–≤.",false);
      paint=null;
      return;
    }
    q.textContent=t.prompt;
    a.value="";
    paint=null;
    setStatus("–ü–æ–∫–∞ –Ω–µ—Ç –∫—Ä–∞—Å–∫–∏","–°–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏ –ø—Ä–∏–º–µ—Ä.",false);
  };

  const check=()=>{
    const t=task(); if(!t) return;
    const v=(a.value||"").trim();
    if(!v){ setStatus("–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç","–ó–∞—Ç–µ–º –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª.",false); return; }
    if(v===String(t.answer)){
      paint={answer:String(t.answer), color:t.color||"#ff4d6d"};
      setStatus("–ö—Ä–∞—Å–∫–∞ –≥–æ—Ç–æ–≤–∞","–ù–∞–∂–º–∏ –Ω–∞ –æ–±–ª–∞—Å—Ç—å —Å –æ—Ç–≤–µ—Ç–æ–º "+paint.answer+" (–∑–∞–∫—Ä–∞—Å–∏—Ç—Å—è –≤—Å—ë —Å —ç—Ç–∏–º –æ—Ç–≤–µ—Ç–æ–º).",true);
      showPot(paint.answer, paint.color);
    }else setStatus("–ü–æ—á—Ç–∏!","–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",false);
  };

  const paintAll=(ans)=>{
    let any=false;
    for(const r of regions){
      if(!r.painted && String(r.answer).trim()===ans){
        r.painted=true;
        any=true;
      }
    }
    return any;
  };

  const onClick=(id)=>{
    if(!paint) return;
    const r=regions.find(x=>x.id===id);
    if(!r) return;
    if(String(r.answer).trim() !== paint.answer) return;

    if(!paintAll(paint.answer)) return;
    render();
    paint=null;

    if(regions.every(x=>x.painted)){
      setStatus("–ì–æ—Ç–æ–≤–æ!","–í—Å–µ –æ–±–ª–∞—Å—Ç–∏ —Ä–∞—Å–∫—Ä–∞—à–µ–Ω—ã üéâ",false);
      return;
    }

    idx++;
    loadTask();
  };

  document.getElementById("check").addEventListener("click",check);
  document.getElementById("next").addEventListener("click",()=>{idx++; loadTask();});
  a.addEventListener("keydown",(e)=>{if(e.key==="Enter") check();});

  img.onload=()=>{ calcContainBox(); render(); loadTask(); };
  window.addEventListener("resize", ()=>{ calcContainBox(); });

  img.src=payload.imageSrc;
})();
</script>
</body></html>`;
  };

  const refreshPreview=()=>{
    try{
      const payload=buildPayload();
      els.gamePreview.srcdoc = buildGameHtml(payload);
      if(payload._missingAnswers?.length){
        toast("–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤: " + payload._missingAnswers.join(", "), "bad");
      }
    }catch{}
  };

  const toB64 = (str)=> btoa(unescape(encodeURIComponent(str)));

  const buildEmbedIframe = (gameHtml)=>{
    const b64 = toB64(gameHtml);
    const wrapper = `<!doctype html><html lang="ru"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head>
<body style="margin:0;background:transparent;overflow:hidden">
<iframe id="inner" style="width:100%;height:100vh;border:0;overflow:hidden"></iframe>
<script>
const html=decodeURIComponent(escape(atob('${b64}')));
document.getElementById('inner').srcdoc=html;
<\\/script>
</body></html>`;

    const safe = wrapper
      .replace(/&/g,"&amp;")
      .replace(/"/g,"&quot;");

    return `<iframe style="width:100%;height:600px;border:0;border-radius:12px;overflow:hidden;"
sandbox="allow-scripts allow-same-origin allow-forms"
srcdoc="${safe}"></iframe>`;
  };

  const makeEmbed = ()=>{
    try{
      const payload=buildPayload();
      const gameHtml=buildGameHtml(payload);
      els.embedOut.value = buildEmbedIframe(gameHtml);
      toast("–ö–æ–¥ –≥–æ—Ç–æ–≤.","ok");
      if(payload._missingAnswers?.length){
        toast("–ù–æ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π –¥–ª—è: " + payload._missingAnswers.join(", "), "bad");
      }
    }catch(e){
      if(e.message==="no-image") toast("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É.","bad");
      else if(e.message==="no-regions") toast("–ù—É–∂–Ω–∞ –º–∏–Ω–∏–º—É–º 1 –æ–±–ª–∞—Å—Ç—å.","bad");
      else if(e.message==="no-tasks") toast("–ù—É–∂–Ω—ã –∑–∞–¥–∞–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ –≤ —Å–ø–∏—Å–∫–µ).","bad");
      else toast("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –∫–æ–¥.","bad");
    }
  };

  const copyEmbed = async ()=>{
    if(!els.embedOut.value.trim()){ toast("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª.","bad"); return; }
    try{
      await navigator.clipboard.writeText(els.embedOut.value);
      toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ.","ok");
    }catch{
      toast("–°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é.","bad");
      els.embedOut.focus(); els.embedOut.select();
    }
  };

  // wire
  els.svg.addEventListener("click", addPoint);

  els.btnUndo.addEventListener("click", undoPoint);
  els.btnClear.addEventListener("click", ()=>{clearPoints(); toast("–¢–æ—á–∫–∏ –æ—á–∏—â–µ–Ω—ã.","ok");});
  els.btnNew.addEventListener("click", newOutline);
  els.btnSaveRegion.addEventListener("click", saveRegion);

  els.btnDelete.addEventListener("click", deleteSelected);
  els.btnDuplicate.addEventListener("click", duplicateSelected);

  els.btnApply.addEventListener("click", applyFields);
  els.btnShow.addEventListener("click", showSelectedPreview);

  els.btnLoad.addEventListener("click", ()=>{ loadImage().catch(()=>toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.","bad")); });
  els.btnFit.addEventListener("click", fit);

  els.btnRefreshPreview.addEventListener("click", ()=>{ refreshPreview(); toast("–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–Ω–æ–≤–ª—ë–Ω.","ok"); });
  els.btnMakeEmbed.addEventListener("click", makeEmbed);
  els.btnCopyEmbed.addEventListener("click", copyEmbed);

  els.preset.addEventListener("change", ()=>{
    const v=els.preset.value;
    if(v!=="__custom__"){
      els.imgUrl.value=v;
      els.filePick.value="";
      loadImage().catch(()=>{});
    }
  });

  // –ö–õ–Æ–ß–ï–í–û–ï: —Ñ–∞–π–ª –≤—ã–±—Ä–∞–Ω ‚Üí —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  els.filePick.addEventListener("change", ()=>{
    if(els.filePick.files && els.filePick.files[0]){
      els.preset.value="__custom__";
      els.imgUrl.value="";
      loadImage().catch(()=>toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª. –û—Ç–∫—Ä–æ–π –≤ Chrome/Safari.","bad"));
    }
  });

  // Enter –≤ —Å—Å—ã–ª–∫–µ
  els.imgUrl.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      els.preset.value="__custom__";
      els.filePick.value="";
      loadImage().catch(()=>{});
    }
  });

  els.fldColor.addEventListener("input", ()=>{ els.fldColorHex.value=els.fldColor.value; });
  els.fldColorHex.addEventListener("input", ()=>{
    const x=hexNormalize(els.fldColorHex.value);
    if(x){ els.fldColorHex.value=x; els.fldColor.value=x; }
  });

  // init
  els.tasksText.value = defaultTasks;
  els.imgUrl.value = DEFAULT_URL;

  renderList();
  renderOverlay();

  loadImage().catch(()=>{});
  window.addEventListener("resize", ()=>{ if(state.imgLoaded) calcContainBox(); });

})();
</script>
</body>
</html>
