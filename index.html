<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Редактор раскраски v2.0</title>
<style>
  :root{
    --text:#eef3ff; --muted:rgba(238,243,255,.72);
    --ok:#28d7a7; --bad:#ff4d6d; --line:rgba(255,255,255,.12);
    --primary:#7aa6ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; color:var(--text); font-family:system-ui,-apple-system,sans-serif; background:#0b1020;}
  .app{height:100vh; display:grid; grid-template-columns:400px 1fr; gap:0;}
  
  /* Левая панель */
  .left{background:#111827; border-right:1px solid var(--line); display:flex; flex-direction:column; overflow:hidden;}
  .head{padding:20px; border-bottom:1px solid var(--line); background:rgba(0,0,0,0.2)}
  .title{font-weight:900; font-size:20px; color:var(--ok)}
  .scroll{padding:20px; overflow-y:auto; flex:1;}
  
  .sec{margin-bottom:20px; padding:15px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,0.03)}
  .sec h3{margin:0 0 12px; font-size:11px; text-transform:uppercase; letter-spacing:1px; color:var(--muted)}
  
  label{display:block; margin:10px 0 5px; font-size:12px; color:var(--muted)}
  input, textarea, select{
    width:100%; padding:10px; border-radius:8px; border:1px solid var(--line);
    background:#050817; color:#fff; outline:none; font-size:14px;
  }
  
  .btnRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
  .btn{
    flex:1; border:0; cursor:pointer; padding:10px; border-radius:8px;
    font-weight:bold; background:var(--ok); color:#000; transition:0.2s;
  }
  .btn:hover{filter:brightness(1.1)}
  .btn.secondary{background:var(--line); color:#fff}
  .btn.danger{background:var(--bad); color:#fff}
  
  /* Правая панель */
  .right{display:grid; grid-template-rows:1fr 250px; background:#050817;}
  .stage{display:flex; align-items:center; justify-content:center; padding:20px; position:relative;}
  .frame{
    position:relative; max-width:100%; max-height:100%; 
    box-shadow:0 0 40px rgba(0,0,0,0.5); background:#111; line-height:0;
  }
  #mainImg{max-width:100%; max-height:70vh; display:block; pointer-events:none;}
  #mainSvg{position:absolute; top:0; left:0; width:100%; height:100%; cursor:crosshair;}
  
  .preview-area{border-top:1px solid var(--line); background:#0b1020; padding:10px;}
  iframe{width:100%; height:100%; border:0; border-radius:10px; background:#fff;}
  
  .list-item{
    padding:8px; background:rgba(0,0,0,0.2); border:1px solid var(--line); 
    border-radius:6px; margin-bottom:5px; font-size:12px; display:flex; justify-content:space-between;
  }
  .toast{
    position:fixed; top:20px; right:20px; padding:12px 20px; 
    background:var(--ok); color:#000; border-radius:8px; font-weight:bold;
    transform:translateY(-100px); transition:0.3s; z-index:9999;
  }
  .toast.show{transform:translateY(0);}
</style>
</head>
<body>

<div id="toast" class="toast">Готово!</div>

<div class="app">
  <div class="left">
    <div class="head">
      <div class="title">COLOR BY NUMBER BUILDER</div>
      <div style="font-size:11px; color:var(--muted)">v2.0 • Специально для Genially</div>
    </div>
    
    <div class="scroll">
      <div class="sec">
        <h3>1. Картинка</h3>
        <input type="file" id="fileInp" accept="image/*">
        <label>Или ссылка:</label>
        <input type="text" id="urlInp" placeholder="https://...">
        <div class="btnRow">
          <button class="btn" onclick="loadByUrl()">Загрузить по ссылке</button>
        </div>
      </div>

      <div class="sec">
        <h3>2. Обводка областей</h3>
        <div style="font-size:12px; margin-bottom:10px">Кликайте по картинке, чтобы ставить точки.</div>
        <div class="btnRow">
          <button class="btn secondary" onclick="undoPoint()">Шаг назад</button>
          <button class="btn danger" onclick="clearPoints()">Очистить</button>
        </div>
        <label>Ответ для этой области:</label>
        <input type="text" id="ansInp" placeholder="Например: 12">
        <button class="btn" style="margin-top:10px; width:100%" onclick="saveRegion()">СОХРАНИТЬ ОБЛАСТЬ</button>
      </div>

      <div class="sec">
        <h3>3. Задания (Список)</h3>
        <div id="regList"></div>
      </div>

      <div class="sec">
        <h3>4. Экспорт</h3>
        <button class="btn" style="background:var(--primary)" onclick="buildGame()">СГЕНЕРИРОВАТЬ ИГРУ</button>
        <label>Код для Genially (Iframe):</label>
        <textarea id="output" style="height:80px; font-size:10px" readonly></textarea>
        <button class="btn secondary" style="width:100%; margin-top:5px" onclick="copyCode()">Копировать код</button>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="stage">
      <div class="frame">
        <img id="mainImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        <svg id="mainSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
      </div>
    </div>
    <div class="preview-area">
      <iframe id="preview"></iframe>
    </div>
  </div>
</div>

<script>
  let points = [];
  let regions = [];
  let currentImgData = "";

  const svg = document.getElementById('mainSvg');
  const img = document.getElementById('mainImg');

  // Загрузка файла с ПК
  document.getElementById('fileInp').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function(event) {
      setImg(event.target.result);
    };
    reader.readAsDataURL(e.target.files[0]);
  };

  function loadByUrl() {
    const url = document.getElementById('urlInp').value;
    if(url) setImg(url);
  }

  function setImg(src) {
    img.src = src;
    currentImgData = src;
    regions = [];
    points = [];
    updateUI();
    showToast("Картинка загружена");
  }

  // Рисование
  svg.onclick = function(e) {
    const rect = svg.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 1000;
    const y = ((e.clientY - rect.top) / rect.height) * 1000;
    points.push({x, y});
    draw();
  };

  function draw() {
    let h = '';
    // Отрисовка текущих точек
    if(points.length > 0) {
      const path = points.map(p => `${p.x},${p.y}`).join(' ');
      h += `<polyline points="${path}" fill="none" stroke="#28d7a7" stroke-width="3" />`;
      points.forEach(p => h += `<circle cx="${p.x}" cy="${p.y}" r="5" fill="#fff" />`);
    }
    // Отрисовка сохраненных областей
    regions.forEach(r => {
      const path = r.points.map(p => `${p.x},${p.y}`).join(' ');
      h += `<polygon points="${path}" fill="rgba(40,215,167,0.3)" stroke="#28d7a7" stroke-width="1" />`;
    });
    svg.innerHTML = h;
  }

  function undoPoint() { points.pop(); draw(); }
  function clearPoints() { points = []; draw(); }

  function saveRegion() {
    const ans = document.getElementById('ansInp').value;
    if(!ans || points.length < 3) return alert("Нужен ответ и хотя бы 3 точки!");
    
    regions.push({
      answer: ans,
      points: [...points],
      color: "#" + Math.floor(Math.random()*16777215).toString(16) // случайный цвет
    });
    
    points = [];
    document.getElementById('ansInp').value = "";
    updateUI();
    draw();
    showToast("Область сохранена");
  }

  function updateUI() {
    const list = document.getElementById('regList');
    list.innerHTML = regions.map((r, i) => `
      <div class="list-item">
        <span>Область #${i+1} (Ответ: ${r.answer})</span>
        <button onclick="regions.splice(${i},1); updateUI(); draw();" style="border:0; background:none; color:red; cursor:pointer">✖</button>
      </div>
    `).join('');
  }

  function showToast(m) {
    const t = document.getElementById('toast');
    t.textContent = m;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }

  function buildGame() {
    if(!currentImgData || regions.length === 0) return alert("Сначала загрузите фото и создайте области!");
    
    const gameData = {
      img: currentImgData,
      regions: regions
    };

    // Генерируем полный HTML игры
    const fullHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { margin: 0; background: #eee; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    #ui { padding: 20px; background: #fff; display: flex; gap: 20px; align-items: center; border-bottom: 2px solid #ddd; }
    #container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; padding: 20px; background: #333; }
    .frame { position: relative; background: #000; line-height: 0; }
    img { max-width: 100%; max-height: 70vh; display: block; }
    svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .task { font-size: 24px; font-weight: bold; }
    input { font-size: 20px; padding: 5px; width: 100px; }
    .btn { padding: 10px 20px; background: #28d7a7; border: 0; border-radius: 5px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
  <div id="ui">
    <div class="task" id="q">Решите примеры, чтобы раскрасить!</div>
    <input type="text" id="ans" placeholder="Ответ...">
    <button class="btn" onclick="check()">ПРОВЕРИТЬ</button>
    <div id="stat"></div>
  </div>
  <div id="container">
    <div class="frame">
      <img src="${gameData.img}">
      <svg id="gameSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <script>
    const data = ${JSON.stringify(gameData.regions)};
    let solved = [];

    function render() {
      let h = '';
      data.forEach((r, i) => {
        const isSolved = solved.includes(r.answer);
        const path = r.points.map(p => p.x + ',' + p.y).join(' ');
        h += '<polygon points="' + path + '" fill="' + (isSolved ? r.color : 'rgba(255,255,255,0.8)') + '" stroke="#999" stroke-width="1" />';
      });
      document.getElementById('gameSvg').innerHTML = h;
    }

    function check() {
      const val = document.getElementById('ans').value.trim();
      let found = false;
      data.forEach(r => {
        if(r.answer === val) {
          if(!solved.includes(val)) solved.push(val);
          found = true;
        }
      });
      if(found) {
        document.getElementById('ans').value = "";
        render();
        if(solved.length === new Set(data.map(d=>d.answer)).size) alert("Ура! Все раскрашено!");
      } else {
        alert("Неправильно или такого номера нет!");
      }
    }
    render();
  <\/script>
</body>
</html>`;

    const encoded = btoa(unescape(encodeURIComponent(fullHtml)));
    const embedCode = `<iframe srcdoc="${fullHtml.replace(/"/g, '&quot;').replace(/'/g, '&apos;')}" width="100%" height="600" style="border:0; border-radius:10px;" allowfullscreen></iframe>`;
    
    document.getElementById('output').value = embedCode;
    document.getElementById('preview').srcdoc = fullHtml;
  }

  function copyCode() {
    const copyText = document.getElementById("output");
    copyText.select();
    document.execCommand("copy");
    showToast("Код скопирован!");
  }
</script>

</body>
</html>
